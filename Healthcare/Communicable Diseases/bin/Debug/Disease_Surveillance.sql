/*
Deployment script for Disease_Surveillance

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "Disease_Surveillance"
:setvar DefaultFilePrefix "Disease_Surveillance"
:setvar DefaultDataPath "C:\Users\esobr\AppData\Local\Microsoft\VisualStudio\SSDT\Datovy"
:setvar DefaultLogPath "C:\Users\esobr\AppData\Local\Microsoft\VisualStudio\SSDT\Datovy"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Dropping Default Constraint unnamed constraint on [Entity].[Contact]...';


GO
ALTER TABLE [Entity].[Contact] DROP CONSTRAINT [DF__Contact__Data_Ow__50C5FA01];


GO
PRINT N'Dropping Default Constraint unnamed constraint on [Entity].[Contact]...';


GO
ALTER TABLE [Entity].[Contact] DROP CONSTRAINT [DF__Contact__Tenant___4FD1D5C8];


GO
PRINT N'Dropping Default Constraint unnamed constraint on [Entity].[Contact]...';


GO
ALTER TABLE [Entity].[Contact] DROP CONSTRAINT [DF__Contact__Session__5772F790];


GO
PRINT N'Dropping Default Constraint unnamed constraint on [Entity].[Contact]...';


GO
ALTER TABLE [Entity].[Contact] DROP CONSTRAINT [DF__Contact__Record___567ED357];


GO
PRINT N'Dropping Default Constraint unnamed constraint on [Entity].[Contact]...';


GO
ALTER TABLE [Entity].[Contact] DROP CONSTRAINT [DF__Contact__Sequenc__51BA1E3A];


GO
PRINT N'Dropping Default Constraint unnamed constraint on [Entity].[Contact]...';


GO
ALTER TABLE [Entity].[Contact] DROP CONSTRAINT [DF__Contact__Efectiv__52AE4273];


GO
PRINT N'Dropping Default Constraint unnamed constraint on [Entity].[Contact]...';


GO
ALTER TABLE [Entity].[Contact] DROP CONSTRAINT [DF__Contact__Created__54968AE5];


GO
PRINT N'Dropping Default Constraint unnamed constraint on [Entity].[Contact]...';


GO
ALTER TABLE [Entity].[Contact] DROP CONSTRAINT [DF__Contact__Version__53A266AC];


GO
PRINT N'Dropping Default Constraint unnamed constraint on [Entity].[Contact]...';


GO
ALTER TABLE [Entity].[Contact] DROP CONSTRAINT [DF__Contact__Updated__558AAF1E];


GO
PRINT N'Dropping Foreign Key [Application].[fk_Application_Contact]...';


GO
ALTER TABLE [Application].[Session] DROP CONSTRAINT [fk_Application_Contact];


GO
PRINT N'Dropping Foreign Key [Core].[fk_Activity_Contact]...';


GO
ALTER TABLE [Core].[Activity] DROP CONSTRAINT [fk_Activity_Contact];


GO
PRINT N'Dropping Foreign Key [Core].[fk_Participant_Contact]...';


GO
ALTER TABLE [Core].[Participant] DROP CONSTRAINT [fk_Participant_Contact];


GO
PRINT N'Dropping Foreign Key [Core].[fk_Note_Contact]...';


GO
ALTER TABLE [Core].[Note] DROP CONSTRAINT [fk_Note_Contact];


GO
PRINT N'Dropping Foreign Key [Core].[fk_Item_Reference_Link_Contact]...';


GO
ALTER TABLE [Core].[Item_Entity_Link] DROP CONSTRAINT [fk_Item_Reference_Link_Contact];


GO
PRINT N'Dropping Foreign Key [Surveillance].[fk_Travel_Detail_Contact]...';


GO
ALTER TABLE [Surveillance].[Travel_Detail] DROP CONSTRAINT [fk_Travel_Detail_Contact];


GO
PRINT N'Dropping Foreign Key [Core].[fk_Element_Contact]...';


GO
ALTER TABLE [Core].[Element] DROP CONSTRAINT [fk_Element_Contact];


GO
PRINT N'Dropping Foreign Key [Entity].[fk_Contact_ContactType]...';


GO
ALTER TABLE [Entity].[Contact] DROP CONSTRAINT [fk_Contact_ContactType];


GO
PRINT N'Dropping Foreign Key [Entity].[fk_Contact_Person]...';


GO
ALTER TABLE [Entity].[Contact] DROP CONSTRAINT [fk_Contact_Person];


GO
PRINT N'Dropping Foreign Key [Entity].[fk_Officer_Contact]...';


GO
ALTER TABLE [Entity].[Officer] DROP CONSTRAINT [fk_Officer_Contact];


GO
PRINT N'Dropping Foreign Key [Entity].[fk_Entity_Location_Link_Contact]...';


GO
ALTER TABLE [Entity].[Entity_Location_Link] DROP CONSTRAINT [fk_Entity_Location_Link_Contact];


GO
PRINT N'Dropping Foreign Key [Entity].[fk_Identification_Contact]...';


GO
ALTER TABLE [Entity].[Identification] DROP CONSTRAINT [fk_Identification_Contact];


GO
PRINT N'Creating Schema [Generic]...';


GO
CREATE SCHEMA [Generic]
    AUTHORIZATION [dbo];


GO
PRINT N'Starting rebuilding table [Entity].[Contact]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [Entity].[tmp_ms_xx_Contact] (
    [Contact_ID]            VARCHAR (30)       NOT NULL,
    [Alternate_ID]          VARCHAR (40)       NULL,
    [Type_ID]               VARCHAR (30)       NULL,
    [Name]                  VARCHAR (128)      NULL,
    [Description]           VARCHAR (256)      NULL,
    [Sex_Code_ID]           VARCHAR (30)       NULL,
    [Phone_Number]          VARCHAR (20)       NULL,
    [Email_Addresss]        VARCHAR (128)      NULL,
    [Risk_Code_ID]          VARCHAR (30)       NULL,
    [Priority_Code_ID]      VARCHAR (30)       NULL,
    [Jurisdiction_Code_ID]  VARCHAR (30)       NULL,
    [Status_Code_ID]        VARCHAR (30)       NULL,
    [Status_DateTime]       DATETIMEOFFSET (7) NULL,
    [Entity_Type_ID]        VARCHAR (30)       NULL,
    [Person_ID]             VARCHAR (30)       NULL,
    [Organization_ID]       VARCHAR (30)       NULL,
    [Officer_ID]            VARCHAR (30)       NULL,
    [Tenant_ID]             VARCHAR (30)       DEFAULT 'COMMON' NULL,
    [Data_Owner_ID]         VARCHAR (30)       DEFAULT 'COMMON' NULL,
    [Agency_Reporting_ID]   VARCHAR (30)       NULL,
    [Sequence_Number]       INT                DEFAULT 0 NULL,
    [Efective_DateTime]     DATETIMEOFFSET (7) DEFAULT getutcdate() NULL,
    [Efective_End_DateTime] DATETIMEOFFSET (7) NULL,
    [Version_Number]        VARCHAR (20)       DEFAULT '0' NULL,
    [Created_DateTime]      DATETIMEOFFSET (7) DEFAULT getutcdate() NULL,
    [Updated_Last_DateTime] DATETIMEOFFSET (7) DEFAULT getutcdate() NULL,
    [Record_Status_Code_ID] CHAR (1)           DEFAULT 'A' NULL,
    [Session_Updated_ID]    VARCHAR (40)       DEFAULT 'E4D32AEC-E7C8-426C-94A6-F0B37F626E67' NULL,
    CONSTRAINT [tmp_ms_xx_constraint_pk_Contact1] PRIMARY KEY CLUSTERED ([Contact_ID] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [Entity].[Contact])
    BEGIN
        INSERT INTO [Entity].[tmp_ms_xx_Contact] ([Contact_ID], [Alternate_ID], [Type_ID], [Person_ID], [Name], [Description], [Sex_Code_ID], [Phone_Number], [Email_Addresss], [Risk_Code_ID], [Priority_Code_ID], [Jurisdiction_Code_ID], [Status_Code_ID], [Status_DateTime], [Tenant_ID], [Data_Owner_ID], [Agency_Reporting_ID], [Sequence_Number], [Efective_DateTime], [Efective_End_DateTime], [Version_Number], [Created_DateTime], [Updated_Last_DateTime], [Record_Status_Code_ID], [Session_Updated_ID])
        SELECT   [Contact_ID],
                 [Alternate_ID],
                 [Type_ID],
                 [Person_ID],
                 [Name],
                 [Description],
                 [Sex_Code_ID],
                 [Phone_Number],
                 [Email_Addresss],
                 [Risk_Code_ID],
                 [Priority_Code_ID],
                 [Jurisdiction_Code_ID],
                 [Status_Code_ID],
                 [Status_DateTime],
                 [Tenant_ID],
                 [Data_Owner_ID],
                 [Agency_Reporting_ID],
                 [Sequence_Number],
                 [Efective_DateTime],
                 [Efective_End_DateTime],
                 [Version_Number],
                 [Created_DateTime],
                 [Updated_Last_DateTime],
                 [Record_Status_Code_ID],
                 [Session_Updated_ID]
        FROM     [Entity].[Contact]
        ORDER BY [Contact_ID] ASC;
    END

DROP TABLE [Entity].[Contact];

EXECUTE sp_rename N'[Entity].[tmp_ms_xx_Contact]', N'Contact';

EXECUTE sp_rename N'[Entity].[tmp_ms_xx_constraint_pk_Contact1]', N'pk_Contact', N'OBJECT';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Creating Table [Generic].[Element_Type]...';


GO
CREATE TABLE [Generic].[Element_Type] (
    [Type_ID]               VARCHAR (30)       NOT NULL,
    [Description]           VARCHAR (80)       NULL,
    [Category_ID]           VARCHAR (30)       NULL,
    [Tags]                  VARCHAR (128)      NULL,
    [CodeSet_Name]          VARCHAR (80)       NULL,
    [Tenant_ID]             VARCHAR (30)       NULL,
    [Data_Owner_ID]         VARCHAR (30)       NULL,
    [Agency_Reporting_ID]   VARCHAR (30)       NULL,
    [Sequence_Number]       INT                NULL,
    [Efective_DateTime]     DATETIMEOFFSET (7) NULL,
    [Efective_End_DateTime] DATETIMEOFFSET (7) NULL,
    [Version_Number]        VARCHAR (20)       NULL,
    [Created_DateTime]      DATETIMEOFFSET (7) NULL,
    [Updated_Last_DateTime] DATETIMEOFFSET (7) NULL,
    [Record_Status_Code_ID] CHAR (1)           NULL,
    [Session_Updated_ID]    VARCHAR (40)       NULL,
    CONSTRAINT [pk_Element_Type] PRIMARY KEY CLUSTERED ([Type_ID] ASC)
);


GO
PRINT N'Creating Table [Generic].[Element]...';


GO
CREATE TABLE [Generic].[Element] (
    [Element_ID]            VARCHAR (30)       NOT NULL,
    [Type_ID]               VARCHAR (30)       NOT NULL,
    [Label_Text]            VARCHAR (128)      NULL,
    [Sequence_No]           INT                NULL,
    [Period_To_Comply]      VARCHAR (30)       NULL,
    [Required_Code_ID]      VARCHAR (30)       NULL,
    [Value_Type_ID]         VARCHAR (30)       NULL,
    [Code_Type_ID]          VARCHAR (30)       NULL,
    [Checked]               BIT                NULL,
    [Start_Date]            DATE               NULL,
    [End_Date]              DATE               NULL,
    [Start_Value]           DECIMAL (18)       NULL,
    [End_Value]             DECIMAL (18)       NULL,
    [Value_Numeric]         DECIMAL (18)       NULL,
    [Value_Text]            VARCHAR (128)      NULL,
    [Tenant_ID]             VARCHAR (30)       NULL,
    [Data_Owner_ID]         VARCHAR (30)       NULL,
    [Agency_Reporting_ID]   VARCHAR (30)       NULL,
    [Sequence_Number]       INT                NULL,
    [Efective_DateTime]     DATETIMEOFFSET (7) NULL,
    [Efective_End_DateTime] DATETIMEOFFSET (7) NULL,
    [Version_Number]        VARCHAR (20)       NULL,
    [Created_DateTime]      DATETIMEOFFSET (7) NULL,
    [Updated_Last_DateTime] DATETIMEOFFSET (7) NULL,
    [Record_Status_Code_ID] CHAR (1)           NULL,
    [Session_Updated_ID]    VARCHAR (40)       NULL,
    CONSTRAINT [pk_Element] PRIMARY KEY CLUSTERED ([Element_ID] ASC)
);


GO
PRINT N'Creating Table [Generic].[Element_Value_Type]...';


GO
CREATE TABLE [Generic].[Element_Value_Type] (
    [Type_ID]               VARCHAR (30)       NOT NULL,
    [Description]           VARCHAR (80)       NULL,
    [Category_ID]           VARCHAR (30)       NULL,
    [Tags]                  VARCHAR (128)      NULL,
    [CodeSet_Name]          VARCHAR (80)       NULL,
    [Tenant_ID]             VARCHAR (30)       NULL,
    [Data_Owner_ID]         VARCHAR (30)       NULL,
    [Agency_Reporting_ID]   VARCHAR (30)       NULL,
    [Sequence_Number]       INT                NULL,
    [Efective_DateTime]     DATETIMEOFFSET (7) NULL,
    [Efective_End_DateTime] DATETIMEOFFSET (7) NULL,
    [Version_Number]        VARCHAR (20)       NULL,
    [Created_DateTime]      DATETIMEOFFSET (7) NULL,
    [Updated_Last_DateTime] DATETIMEOFFSET (7) NULL,
    [Record_Status_Code_ID] CHAR (1)           NULL,
    [Session_Updated_ID]    VARCHAR (40)       NULL,
    CONSTRAINT [pk_Element_Value_Type] PRIMARY KEY CLUSTERED ([Type_ID] ASC)
);


GO
PRINT N'Creating Table [Generic].[Element_Value]...';


GO
CREATE TABLE [Generic].[Element_Value] (
    [Element_Value_ID]      VARCHAR (30)       NOT NULL,
    [Element_ID]            VARCHAR (30)       NOT NULL,
    [Type_ID]               VARCHAR (30)       NOT NULL,
    [Sequence_No]           INT                NULL,
    [Reference_Date]        DATE               NULL,
    [Reference_Time]        TIME (7)           NULL,
    [Entity_Type_ID]        VARCHAR (30)       NOT NULL,
    [Entity_ID]             VARCHAR (30)       NOT NULL,
    [Checked]               BIT                NULL,
    [Start_Date]            DATE               NULL,
    [End_Date]              DATE               NULL,
    [Start_Value]           DECIMAL (18)       NULL,
    [End_Value]             DECIMAL (18)       NULL,
    [Value_Numeric]         DECIMAL (18)       NULL,
    [Value_Text]            VARCHAR (128)      NULL,
    [Tenant_ID]             VARCHAR (30)       NULL,
    [Data_Owner_ID]         VARCHAR (30)       NULL,
    [Agency_Reporting_ID]   VARCHAR (30)       NULL,
    [Sequence_Number]       INT                NULL,
    [Efective_DateTime]     DATETIMEOFFSET (7) NULL,
    [Efective_End_DateTime] DATETIMEOFFSET (7) NULL,
    [Version_Number]        VARCHAR (20)       NULL,
    [Created_DateTime]      DATETIMEOFFSET (7) NULL,
    [Updated_Last_DateTime] DATETIMEOFFSET (7) NULL,
    [Record_Status_Code_ID] CHAR (1)           NULL,
    [Session_Updated_ID]    VARCHAR (40)       NULL,
    CONSTRAINT [pk_Element_Value] PRIMARY KEY CLUSTERED ([Element_Value_ID] ASC)
);


GO
PRINT N'Creating Table [Application].[App_Message_Code]...';


GO
CREATE TABLE [Application].[App_Message_Code] (
    [Code_Number]           INT                NOT NULL,
    [Code_ID]               VARCHAR (60)       NULL,
    [Description]           VARCHAR (128)      NULL,
    [Category_ID]           VARCHAR (30)       NULL,
    [CodeSet_Name]          VARCHAR (80)       NULL,
    [Tenant_ID]             VARCHAR (30)       NULL,
    [Data_Owner_ID]         VARCHAR (30)       NULL,
    [Agency_Reporting_ID]   VARCHAR (30)       NULL,
    [Sequence_Number]       INT                NULL,
    [Efective_DateTime]     DATETIMEOFFSET (7) NULL,
    [Efective_End_DateTime] DATETIMEOFFSET (7) NULL,
    [Version_Number]        VARCHAR (20)       NULL,
    [Created_DateTime]      DATETIMEOFFSET (7) NULL,
    [Updated_Last_DateTime] DATETIMEOFFSET (7) NULL,
    [Record_Status_Code_ID] CHAR (1)           NULL,
    [Session_Updated_ID]    VARCHAR (40)       NULL,
    CONSTRAINT [pk_App_Message_Code] PRIMARY KEY CLUSTERED ([Code_Number] ASC)
);


GO
PRINT N'Creating Default Constraint unnamed constraint on [Generic].[Element_Type]...';


GO
ALTER TABLE [Generic].[Element_Type]
    ADD DEFAULT 'COMMON' FOR [Tenant_ID];


GO
PRINT N'Creating Default Constraint unnamed constraint on [Generic].[Element_Type]...';


GO
ALTER TABLE [Generic].[Element_Type]
    ADD DEFAULT 'COMMON' FOR [Data_Owner_ID];


GO
PRINT N'Creating Default Constraint unnamed constraint on [Generic].[Element_Type]...';


GO
ALTER TABLE [Generic].[Element_Type]
    ADD DEFAULT 0 FOR [Sequence_Number];


GO
PRINT N'Creating Default Constraint unnamed constraint on [Generic].[Element_Type]...';


GO
ALTER TABLE [Generic].[Element_Type]
    ADD DEFAULT getutcdate() FOR [Efective_DateTime];


GO
PRINT N'Creating Default Constraint unnamed constraint on [Generic].[Element_Type]...';


GO
ALTER TABLE [Generic].[Element_Type]
    ADD DEFAULT '0' FOR [Version_Number];


GO
PRINT N'Creating Default Constraint unnamed constraint on [Generic].[Element_Type]...';


GO
ALTER TABLE [Generic].[Element_Type]
    ADD DEFAULT getutcdate() FOR [Created_DateTime];


GO
PRINT N'Creating Default Constraint unnamed constraint on [Generic].[Element_Type]...';


GO
ALTER TABLE [Generic].[Element_Type]
    ADD DEFAULT getutcdate() FOR [Updated_Last_DateTime];


GO
PRINT N'Creating Default Constraint unnamed constraint on [Generic].[Element_Type]...';


GO
ALTER TABLE [Generic].[Element_Type]
    ADD DEFAULT 'A' FOR [Record_Status_Code_ID];


GO
PRINT N'Creating Default Constraint unnamed constraint on [Generic].[Element_Type]...';


GO
ALTER TABLE [Generic].[Element_Type]
    ADD DEFAULT 'E4D32AEC-E7C8-426C-94A6-F0B37F626E67' FOR [Session_Updated_ID];


GO
PRINT N'Creating Default Constraint unnamed constraint on [Generic].[Element]...';


GO
ALTER TABLE [Generic].[Element]
    ADD DEFAULT ('P0Y0M0DT0H0M0S') FOR [Period_To_Comply];


GO
PRINT N'Creating Default Constraint unnamed constraint on [Generic].[Element]...';


GO
ALTER TABLE [Generic].[Element]
    ADD DEFAULT 'COMMON' FOR [Tenant_ID];


GO
PRINT N'Creating Default Constraint unnamed constraint on [Generic].[Element]...';


GO
ALTER TABLE [Generic].[Element]
    ADD DEFAULT 'COMMON' FOR [Data_Owner_ID];


GO
PRINT N'Creating Default Constraint unnamed constraint on [Generic].[Element]...';


GO
ALTER TABLE [Generic].[Element]
    ADD DEFAULT 0 FOR [Sequence_Number];


GO
PRINT N'Creating Default Constraint unnamed constraint on [Generic].[Element]...';


GO
ALTER TABLE [Generic].[Element]
    ADD DEFAULT getutcdate() FOR [Efective_DateTime];


GO
PRINT N'Creating Default Constraint unnamed constraint on [Generic].[Element]...';


GO
ALTER TABLE [Generic].[Element]
    ADD DEFAULT '0' FOR [Version_Number];


GO
PRINT N'Creating Default Constraint unnamed constraint on [Generic].[Element]...';


GO
ALTER TABLE [Generic].[Element]
    ADD DEFAULT getutcdate() FOR [Created_DateTime];


GO
PRINT N'Creating Default Constraint unnamed constraint on [Generic].[Element]...';


GO
ALTER TABLE [Generic].[Element]
    ADD DEFAULT getutcdate() FOR [Updated_Last_DateTime];


GO
PRINT N'Creating Default Constraint unnamed constraint on [Generic].[Element]...';


GO
ALTER TABLE [Generic].[Element]
    ADD DEFAULT 'A' FOR [Record_Status_Code_ID];


GO
PRINT N'Creating Default Constraint unnamed constraint on [Generic].[Element]...';


GO
ALTER TABLE [Generic].[Element]
    ADD DEFAULT 'E4D32AEC-E7C8-426C-94A6-F0B37F626E67' FOR [Session_Updated_ID];


GO
PRINT N'Creating Default Constraint unnamed constraint on [Generic].[Element_Value_Type]...';


GO
ALTER TABLE [Generic].[Element_Value_Type]
    ADD DEFAULT 'COMMON' FOR [Tenant_ID];


GO
PRINT N'Creating Default Constraint unnamed constraint on [Generic].[Element_Value_Type]...';


GO
ALTER TABLE [Generic].[Element_Value_Type]
    ADD DEFAULT 'COMMON' FOR [Data_Owner_ID];


GO
PRINT N'Creating Default Constraint unnamed constraint on [Generic].[Element_Value_Type]...';


GO
ALTER TABLE [Generic].[Element_Value_Type]
    ADD DEFAULT 0 FOR [Sequence_Number];


GO
PRINT N'Creating Default Constraint unnamed constraint on [Generic].[Element_Value_Type]...';


GO
ALTER TABLE [Generic].[Element_Value_Type]
    ADD DEFAULT getutcdate() FOR [Efective_DateTime];


GO
PRINT N'Creating Default Constraint unnamed constraint on [Generic].[Element_Value_Type]...';


GO
ALTER TABLE [Generic].[Element_Value_Type]
    ADD DEFAULT '0' FOR [Version_Number];


GO
PRINT N'Creating Default Constraint unnamed constraint on [Generic].[Element_Value_Type]...';


GO
ALTER TABLE [Generic].[Element_Value_Type]
    ADD DEFAULT getutcdate() FOR [Created_DateTime];


GO
PRINT N'Creating Default Constraint unnamed constraint on [Generic].[Element_Value_Type]...';


GO
ALTER TABLE [Generic].[Element_Value_Type]
    ADD DEFAULT getutcdate() FOR [Updated_Last_DateTime];


GO
PRINT N'Creating Default Constraint unnamed constraint on [Generic].[Element_Value_Type]...';


GO
ALTER TABLE [Generic].[Element_Value_Type]
    ADD DEFAULT 'A' FOR [Record_Status_Code_ID];


GO
PRINT N'Creating Default Constraint unnamed constraint on [Generic].[Element_Value_Type]...';


GO
ALTER TABLE [Generic].[Element_Value_Type]
    ADD DEFAULT 'E4D32AEC-E7C8-426C-94A6-F0B37F626E67' FOR [Session_Updated_ID];


GO
PRINT N'Creating Default Constraint unnamed constraint on [Generic].[Element_Value]...';


GO
ALTER TABLE [Generic].[Element_Value]
    ADD DEFAULT 'COMMON' FOR [Tenant_ID];


GO
PRINT N'Creating Default Constraint unnamed constraint on [Generic].[Element_Value]...';


GO
ALTER TABLE [Generic].[Element_Value]
    ADD DEFAULT 'COMMON' FOR [Data_Owner_ID];


GO
PRINT N'Creating Default Constraint unnamed constraint on [Generic].[Element_Value]...';


GO
ALTER TABLE [Generic].[Element_Value]
    ADD DEFAULT 0 FOR [Sequence_Number];


GO
PRINT N'Creating Default Constraint unnamed constraint on [Generic].[Element_Value]...';


GO
ALTER TABLE [Generic].[Element_Value]
    ADD DEFAULT getutcdate() FOR [Efective_DateTime];


GO
PRINT N'Creating Default Constraint unnamed constraint on [Generic].[Element_Value]...';


GO
ALTER TABLE [Generic].[Element_Value]
    ADD DEFAULT '0' FOR [Version_Number];


GO
PRINT N'Creating Default Constraint unnamed constraint on [Generic].[Element_Value]...';


GO
ALTER TABLE [Generic].[Element_Value]
    ADD DEFAULT getutcdate() FOR [Created_DateTime];


GO
PRINT N'Creating Default Constraint unnamed constraint on [Generic].[Element_Value]...';


GO
ALTER TABLE [Generic].[Element_Value]
    ADD DEFAULT getutcdate() FOR [Updated_Last_DateTime];


GO
PRINT N'Creating Default Constraint unnamed constraint on [Generic].[Element_Value]...';


GO
ALTER TABLE [Generic].[Element_Value]
    ADD DEFAULT 'A' FOR [Record_Status_Code_ID];


GO
PRINT N'Creating Default Constraint unnamed constraint on [Generic].[Element_Value]...';


GO
ALTER TABLE [Generic].[Element_Value]
    ADD DEFAULT 'E4D32AEC-E7C8-426C-94A6-F0B37F626E67' FOR [Session_Updated_ID];


GO
PRINT N'Creating Default Constraint unnamed constraint on [Application].[App_Message_Code]...';


GO
ALTER TABLE [Application].[App_Message_Code]
    ADD DEFAULT 'COMMON' FOR [Tenant_ID];


GO
PRINT N'Creating Default Constraint unnamed constraint on [Application].[App_Message_Code]...';


GO
ALTER TABLE [Application].[App_Message_Code]
    ADD DEFAULT 'COMMON' FOR [Data_Owner_ID];


GO
PRINT N'Creating Default Constraint unnamed constraint on [Application].[App_Message_Code]...';


GO
ALTER TABLE [Application].[App_Message_Code]
    ADD DEFAULT 0 FOR [Sequence_Number];


GO
PRINT N'Creating Default Constraint unnamed constraint on [Application].[App_Message_Code]...';


GO
ALTER TABLE [Application].[App_Message_Code]
    ADD DEFAULT getutcdate() FOR [Efective_DateTime];


GO
PRINT N'Creating Default Constraint unnamed constraint on [Application].[App_Message_Code]...';


GO
ALTER TABLE [Application].[App_Message_Code]
    ADD DEFAULT '0' FOR [Version_Number];


GO
PRINT N'Creating Default Constraint unnamed constraint on [Application].[App_Message_Code]...';


GO
ALTER TABLE [Application].[App_Message_Code]
    ADD DEFAULT getutcdate() FOR [Created_DateTime];


GO
PRINT N'Creating Default Constraint unnamed constraint on [Application].[App_Message_Code]...';


GO
ALTER TABLE [Application].[App_Message_Code]
    ADD DEFAULT getutcdate() FOR [Updated_Last_DateTime];


GO
PRINT N'Creating Default Constraint unnamed constraint on [Application].[App_Message_Code]...';


GO
ALTER TABLE [Application].[App_Message_Code]
    ADD DEFAULT 'A' FOR [Record_Status_Code_ID];


GO
PRINT N'Creating Default Constraint unnamed constraint on [Application].[App_Message_Code]...';


GO
ALTER TABLE [Application].[App_Message_Code]
    ADD DEFAULT 'E4D32AEC-E7C8-426C-94A6-F0B37F626E67' FOR [Session_Updated_ID];


GO
PRINT N'Creating Sequence [Message].[Submission_Number]...';


GO
CREATE SEQUENCE [Message].[Submission_Number]
    AS INT
    START WITH 0
    INCREMENT BY 1
    MINVALUE 0
    MAXVALUE 9999999
    CYCLE
    CACHE 15;


GO
PRINT N'Creating Foreign Key [Application].[fk_Application_Contact]...';


GO
ALTER TABLE [Application].[Session] WITH NOCHECK
    ADD CONSTRAINT [fk_Application_Contact] FOREIGN KEY ([Contact_ID]) REFERENCES [Entity].[Contact] ([Contact_ID]);


GO
PRINT N'Creating Foreign Key [Core].[fk_Activity_Contact]...';


GO
ALTER TABLE [Core].[Activity] WITH NOCHECK
    ADD CONSTRAINT [fk_Activity_Contact] FOREIGN KEY ([Contact_ID]) REFERENCES [Entity].[Contact] ([Contact_ID]);


GO
PRINT N'Creating Foreign Key [Core].[fk_Participant_Contact]...';


GO
ALTER TABLE [Core].[Participant] WITH NOCHECK
    ADD CONSTRAINT [fk_Participant_Contact] FOREIGN KEY ([Contact_ID]) REFERENCES [Entity].[Contact] ([Contact_ID]);


GO
PRINT N'Creating Foreign Key [Core].[fk_Note_Contact]...';


GO
ALTER TABLE [Core].[Note] WITH NOCHECK
    ADD CONSTRAINT [fk_Note_Contact] FOREIGN KEY ([Contact_ID]) REFERENCES [Entity].[Contact] ([Contact_ID]);


GO
PRINT N'Creating Foreign Key [Core].[fk_Item_Reference_Link_Contact]...';


GO
ALTER TABLE [Core].[Item_Entity_Link] WITH NOCHECK
    ADD CONSTRAINT [fk_Item_Reference_Link_Contact] FOREIGN KEY ([Contact_ID]) REFERENCES [Entity].[Contact] ([Contact_ID]);


GO
PRINT N'Creating Foreign Key [Surveillance].[fk_Travel_Detail_Contact]...';


GO
ALTER TABLE [Surveillance].[Travel_Detail] WITH NOCHECK
    ADD CONSTRAINT [fk_Travel_Detail_Contact] FOREIGN KEY ([Entity_ID]) REFERENCES [Entity].[Contact] ([Contact_ID]);


GO
PRINT N'Creating Foreign Key [Entity].[fk_Contact_ContactType]...';


GO
ALTER TABLE [Entity].[Contact] WITH NOCHECK
    ADD CONSTRAINT [fk_Contact_ContactType] FOREIGN KEY ([Type_ID]) REFERENCES [Entity].[Contact_Type] ([Type_ID]);


GO
PRINT N'Creating Foreign Key [Entity].[fk_Contact_Person]...';


GO
ALTER TABLE [Entity].[Contact] WITH NOCHECK
    ADD CONSTRAINT [fk_Contact_Person] FOREIGN KEY ([Person_ID]) REFERENCES [Entity].[Person] ([Person_ID]);


GO
PRINT N'Creating Foreign Key [Entity].[fk_Officer_Contact]...';


GO
ALTER TABLE [Entity].[Officer] WITH NOCHECK
    ADD CONSTRAINT [fk_Officer_Contact] FOREIGN KEY ([Contact_ID]) REFERENCES [Entity].[Contact] ([Contact_ID]);


GO
PRINT N'Creating Foreign Key [Entity].[fk_Entity_Location_Link_Contact]...';


GO
ALTER TABLE [Entity].[Entity_Location_Link] WITH NOCHECK
    ADD CONSTRAINT [fk_Entity_Location_Link_Contact] FOREIGN KEY ([Contact_ID]) REFERENCES [Entity].[Contact] ([Contact_ID]);


GO
PRINT N'Creating Foreign Key [Entity].[fk_Identification_Contact]...';


GO
ALTER TABLE [Entity].[Identification] WITH NOCHECK
    ADD CONSTRAINT [fk_Identification_Contact] FOREIGN KEY ([Contact_ID]) REFERENCES [Entity].[Contact] ([Contact_ID]);


GO
PRINT N'Creating Foreign Key [Entity].[fk_Contact_Entity_Type]...';


GO
ALTER TABLE [Entity].[Contact] WITH NOCHECK
    ADD CONSTRAINT [fk_Contact_Entity_Type] FOREIGN KEY ([Entity_Type_ID]) REFERENCES [Entity].[Entity_Type] ([Type_ID]);


GO
PRINT N'Creating Foreign Key [Entity].[fk_Contact_Organization]...';


GO
ALTER TABLE [Entity].[Contact] WITH NOCHECK
    ADD CONSTRAINT [fk_Contact_Organization] FOREIGN KEY ([Organization_ID]) REFERENCES [Entity].[Organization] ([Organization_ID]);


GO
PRINT N'Creating Foreign Key [Entity].[fk_Contact_Officer]...';


GO
ALTER TABLE [Entity].[Contact] WITH NOCHECK
    ADD CONSTRAINT [fk_Contact_Officer] FOREIGN KEY ([Officer_ID]) REFERENCES [Entity].[Officer] ([Officer_ID]);


GO
PRINT N'Creating Foreign Key [Generic].[fk_Element_Type]...';


GO
ALTER TABLE [Generic].[Element] WITH NOCHECK
    ADD CONSTRAINT [fk_Element_Type] FOREIGN KEY ([Type_ID]) REFERENCES [Generic].[Element_Type] ([Type_ID]);


GO
PRINT N'Creating Foreign Key [Generic].[fk_Element_Value_Type]...';


GO
ALTER TABLE [Generic].[Element] WITH NOCHECK
    ADD CONSTRAINT [fk_Element_Value_Type] FOREIGN KEY ([Value_Type_ID]) REFERENCES [Generic].[Element_Value_Type] ([Type_ID]);


GO
PRINT N'Creating Foreign Key [Generic].[fk_Element_Value_Element]...';


GO
ALTER TABLE [Generic].[Element_Value] WITH NOCHECK
    ADD CONSTRAINT [fk_Element_Value_Element] FOREIGN KEY ([Element_ID]) REFERENCES [Generic].[Element] ([Element_ID]);


GO
PRINT N'Creating Foreign Key [Generic].[fk_Element_Value_ID]...';


GO
ALTER TABLE [Generic].[Element_Value] WITH NOCHECK
    ADD CONSTRAINT [fk_Element_Value_ID] FOREIGN KEY ([Type_ID]) REFERENCES [Generic].[Element_Value_Type] ([Type_ID]);


GO
PRINT N'Creating Foreign Key [Generic].[fk_Element_Value_Entity]...';


GO
ALTER TABLE [Generic].[Element_Value] WITH NOCHECK
    ADD CONSTRAINT [fk_Element_Value_Entity] FOREIGN KEY ([Entity_Type_ID]) REFERENCES [Entity].[Entity_Type] ([Type_ID]);


GO
PRINT N'Altering Procedure [Message].[Submission_Upsert]...';


GO

-- The following is based on KnowTech Submission Registry

ALTER PROCEDURE Message.Submission_Upsert
   @Session_ID          VARCHAR(40) = '',
   @Submission_ID       VARCHAR(20) = '',   -- unique submission ID (if new will be null or empty)
   @Submission_DateTime VARCHAR(20) = NULL,    -- date and time submission was prepared
   @Received_DateTime   VARCHAR(20) = NULL,    -- received date and time
   @Content_Type_ID     VARCHAR(30),        -- content type
   @Reference_ID        VARCHAR(30) = NULL, -- Incident ID
   @Source_ID           VARCHAR(40),        -- submitter Agency ID
   @Source_Local_ID     VARCHAR(40) = '',   -- e.g. CFS Local ID
   @Data_Owner_ID       VARCHAR(20) = '',   -- data owner Agency ID as specified in payload.DataOwner
   @Data_Item_ID        VARCHAR(20) = '',   -- submission DataOwner.Data_Item_ID as specified in payload
   @Message_Data        VARCHAR(MAX),       -- CLOB xml message 
   @Content_ID          VARCHAR(20) = '',   -- e.g. GlobalID for CFS
   @Submission_ID_Out   VARCHAR(20) OUTPUT
AS
BEGIN
   SET NOCOUNT ON

   IF NOT EXISTS(SELECT * FROM Message.Content_Type
                  WHERE [Type_ID] = @Content_Type_ID)
      RETURN -4003  -- invalid content-type

   IF @Submission_DateTime is null
      SET @Submission_DateTime = getutcdate()
   IF @Received_DateTime is null
      SET @Received_DateTime = getutcdate()

   DECLARE @MessageLengthInBytes  INTEGER,
           @rval                  INTEGER
   SET @MessageLengthInBytes = len(@Message_Data)

   -- prepare a unique submission id and/or reference id as necessary...
   IF @Submission_ID = '' OR @Submission_ID IS NULL
   BEGIN
      SET @Submission_ID = [Application].[ID_Number_Generate] 
         ('SUB', next value for [Message].[Submission_Number])
   END
   SET @Submission_ID_Out = @Submission_ID

   IF @Data_Item_ID IS NULL OR @Data_Item_ID = ''
      SET @Data_Item_ID = @Submission_ID_Out
   
   -- try to insert submisison now
   BEGIN TRANSACTION SubmissionUpsert

   IF NOT EXISTS (SELECT * FROM [Message].[Submission] with(nolock)
                   WHERE [Submission_ID] = @Submission_ID)
   BEGIN

      -- StateNo = 1 = Registered
      INSERT INTO [Message].[Submission]
         ([Submission_ID],    [Submission_DateTime], [Received_DateTime],
          [Content_Type_ID],  [Source_ID],           [Source_Local_ID],
          [Data_Owner_ID],    [Data_Item_ID],        [Content_ID],
          [Message_Data],     [Message_Count],       [Message_Length_InBytes],
          [Message_DateTime], [Reference_ID],        [Session_Updated_ID])
      VALUES
         (@Submission_ID,     @Submission_DateTime,  @Received_DateTime,
          @Content_Type_ID,   @Source_ID,            @Source_Local_ID,
          @Data_Owner_ID,     @Data_Item_ID,         @Content_ID,
          @Message_Data,      1,                     @MessageLengthInBytes,
          @Received_DateTime, @Reference_ID,         @Session_ID)

      IF @@ERROR <> 0
      BEGIN
         ROLLBACK TRAN SubmissionUpsert
         RETURN -3001    -- failed inserting submission...
      END
   END
   ELSE
   BEGIN
      UPDATE [Message].[Submission]
         SET Message_Count = Message_Count + 1
       WHERE Submission_ID = @Submission_ID

      IF @@ERROR <> 0
      BEGIN
         ROLLBACK TRAN SubmissionUpsert
         RETURN -3002    -- failed updating submission count...
      END
   END

   COMMIT TRANSACTION SubmissionUpsert
END
GO
PRINT N'Creating Extended Property [Entity].[Contact].[Jurisdiction_Code_ID].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = 'have the information for the jurisdiction -- jurisdiction table will be required.', @level0type = N'SCHEMA', @level0name = N'Entity', @level1type = N'TABLE', @level1name = N'Contact', @level2type = N'COLUMN', @level2name = N'Jurisdiction_Code_ID';


GO
PRINT N'Checking existing data against newly created constraints';


GO
USE [$(DatabaseName)];


GO
ALTER TABLE [Application].[Session] WITH CHECK CHECK CONSTRAINT [fk_Application_Contact];

ALTER TABLE [Core].[Activity] WITH CHECK CHECK CONSTRAINT [fk_Activity_Contact];

ALTER TABLE [Core].[Participant] WITH CHECK CHECK CONSTRAINT [fk_Participant_Contact];

ALTER TABLE [Core].[Note] WITH CHECK CHECK CONSTRAINT [fk_Note_Contact];

ALTER TABLE [Core].[Item_Entity_Link] WITH CHECK CHECK CONSTRAINT [fk_Item_Reference_Link_Contact];

ALTER TABLE [Surveillance].[Travel_Detail] WITH CHECK CHECK CONSTRAINT [fk_Travel_Detail_Contact];

ALTER TABLE [Entity].[Contact] WITH CHECK CHECK CONSTRAINT [fk_Contact_ContactType];

ALTER TABLE [Entity].[Contact] WITH CHECK CHECK CONSTRAINT [fk_Contact_Person];

ALTER TABLE [Entity].[Officer] WITH CHECK CHECK CONSTRAINT [fk_Officer_Contact];

ALTER TABLE [Entity].[Entity_Location_Link] WITH CHECK CHECK CONSTRAINT [fk_Entity_Location_Link_Contact];

ALTER TABLE [Entity].[Identification] WITH CHECK CHECK CONSTRAINT [fk_Identification_Contact];

ALTER TABLE [Entity].[Contact] WITH CHECK CHECK CONSTRAINT [fk_Contact_Entity_Type];

ALTER TABLE [Entity].[Contact] WITH CHECK CHECK CONSTRAINT [fk_Contact_Organization];

ALTER TABLE [Entity].[Contact] WITH CHECK CHECK CONSTRAINT [fk_Contact_Officer];

ALTER TABLE [Generic].[Element] WITH CHECK CHECK CONSTRAINT [fk_Element_Type];

ALTER TABLE [Generic].[Element] WITH CHECK CHECK CONSTRAINT [fk_Element_Value_Type];

ALTER TABLE [Generic].[Element_Value] WITH CHECK CHECK CONSTRAINT [fk_Element_Value_Element];

ALTER TABLE [Generic].[Element_Value] WITH CHECK CHECK CONSTRAINT [fk_Element_Value_ID];

ALTER TABLE [Generic].[Element_Value] WITH CHECK CHECK CONSTRAINT [fk_Element_Value_Entity];


GO
PRINT N'Update complete.';


GO
